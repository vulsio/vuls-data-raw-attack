{
  "type": "relationship",
  "id": "relationship--a72eb24f-256b-4d88-a839-55d1d35833bb",
  "created": "2022-06-16T13:06:00.574Z",
  "created_by_ref": "identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5",
  "description": "Monitor for newly executed processes executed from the Run/RunOnce registry keys through Windows EID 9707 or “Software\\Microsoft\\Windows\\CurrentVersion\\Run” and “Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce” registry keys with the full command line.\n\nRegistry modifications are often essential in establishing persistence via known Windows mechanisms. Many legitimate modifications are done graphically via regedit.exe or by using the corresponding channels, or even calling the Registry APIs directly. The built-in utility reg.exe provides a command-line interface to the registry, so that queries and modifications can be performed from a shell, such as cmd.exe. When a user is responsible for these actions, the parent of cmd.exe will likely be explorer.exe. Occasionally, power users and administrators write scripts that do this behavior as well, but likely from a different process tree. These background scripts must be learned so they can be tuned out accordingly.\n\nOutput Description\nThe sequence of processes that resulted in reg.exe being started from a shell. That is, a hierarchy that looks like\n• great-grand_parent.exe\n• grand_parent.exe\n• parent.exe\n• reg.exe\n\n<h4>Analytic 1 - Reg.exe called from Command Shell </h4>\n<code>reg = filter processes where (exe == \"reg.exe\" and parent_exe == \"cmd.exe\")\ncmd = filter processes where (exe == \"cmd.exe\" and parent_exe != \"explorer.exe\"\")\nreg_and_cmd = join (reg, cmd) where (reg.ppid == cmd.pid and reg.hostname == cmd.hostname)</code>\n\n<h4>Analytic 2 - Rare LolBAS Command Lines</h4>\n<code>lolbas_processes = filter processes where (exe = \"At.exe\" OR exe = \"Atbroker.exe\" OR exe = \"Bash.exe\" OR exe = \"Bitsadmin.exe\" OR exe = \"Certutil.exe\" OR exe = \"Cmd.exe\" OR exe = \"Cmdkey.exe\" OR exe = \"Cmstp.exe\" OR exe = \"Control.exe\" OR exe = \"Csc.exe\" OR exe = \"Cscript.exe\" OR exe = \"Dfsvc.exe\" OR exe = \"Diskshadow.exe\" OR exe = \"Dnscmd.exe\" OR exe = \"Esentutl.exe\" OR exe = \"Eventvwr.exe\" OR exe = \"Expand.exe\" OR exe = \"Extexport.exe\" OR exe = \"Extrac32.exe\" OR exe = \"Findstr.exe\" OR exe = \"Forfiles.exe\" OR exe = \"Ftp.exe\" OR exe = \"Gpscript.exe\" OR exe = \"Hh.exe\" OR exe = \"Ie4uinit.exe\" OR exe = \"Ieexec.exe\" OR exe = \"Infdefaultinstall.exe\" OR exe = \"Installutil.exe\" OR exe = \"Jsc.exe\" OR exe = \"Makecab.exe\" OR exe = \"Mavinject.exe\" OR exe = \"Microsoft.Workflow.r.exe\" OR exe = \"Mmc.exe\" OR exe = \"Msbuild.exe\" OR exe = \"Msconfig.exe\" OR exe = \"Msdt.exe\" OR exe = \"Mshta.exe\" OR exe = \"Msiexec.exe\" OR exe = \"Odbcconf.exe\" OR exe = \"Pcalua.exe\" OR exe = \"Pcwrun.exe\" OR exe = \"Presentationhost.exe\" OR exe = \"Print.exe\" OR exe = \"Reg.exe\" OR exe = \"Regasm.exe\" OR exe = \"Regedit.exe\" OR exe = \"Register-cimprovider.exe\" OR exe = \"Regsvcs.exe\" OR exe = \"Regsvr32.exe\" OR exe = \"Replace.exe\" OR exe = \"Rpcping.exe\" OR exe = \"Rundll32.exe\" OR exe = \"Runonce.exe\" OR exe = \"Runscripthelper.exe\" OR exe = \"Sc.exe\" OR exe = \"Schtasks.exe\" OR exe = \"Scriptrunner.exe\" OR exe = \"SyncAppvPublishingServer.exe\" OR exe = \"Tttracer.exe\" OR exe = \"Verclsid.exe\" OR exe = \"Wab.exe\" OR exe = \"Wmic.exe\" OR exe = \"Wscript.exe\" OR exe = \"Wsreset.exe\" OR exe = \"Xwizard.exe\" OR exe = \"Advpack.dll OR exe = \"Comsvcs.dll OR exe = \"Ieadvpack.dll OR exe = \"Ieaframe.dll OR exe = \"Mshtml.dll OR exe = \"Pcwutl.dll OR exe = \"Setupapi.dll OR exe = \"Shdocvw.dll OR exe = \"Shell32.dll OR exe = \"Syssetup.dll OR exe = \"Url.dll OR exe = \"Zipfldr.dll OR exe = \"Appvlp.exe\" OR exe = \"Bginfo.exe\" OR exe = \"Cdb.exe\" OR exe = \"csi.exe\" OR exe = \"Devtoolslauncher.exe\" OR exe = \"dnx.exe\" OR exe = \"Dxcap.exe\" OR exe = \"Excel.exe\" OR exe = \"Mftrace.exe\" OR exe = \"Msdeploy.exe\" OR exe = \"msxsl.exe\" OR exe = \"Powerpnt.exe\" OR exe = \"rcsi.exe\" OR exe = \"Sqler.exe\" OR exe = \"Sqlps.exe\" OR exe = \"SQLToolsPS.exe\" OR exe = \"Squirrel.exe\" OR exe = \"te.exe\" OR exe = \"Tracker.exe\" OR exe = \"Update.exe\" OR exe = \"vsjitdebugger.exe\" OR exe = \"Winword.exe\" OR exe = \"Wsl.exe\" OR exe = \"CL_Mutexverifiers.ps1 OR exe = \"CL_Invocation.ps1 OR exe = \"Manage-bde.wsf OR exe = \"Pubprn.vbs OR exe = \"Slmgr.vbs OR exe = \"Syncappvpublishingserver.vbs OR exe = \"winrm.vbs OR exe = \"Pester.bat)\nprocess_count = count(lolbas_processes) by process\nprocess_count_avg = average(process_count)\nprocess_count_stdev = standard_deviation(process_count)\nlower_bound = process_count_avg - stdev * 1.5\noutliers = filter lolbas_processes where (process_count < lower_bound)</code>",
  "modified": "2023-09-15T17:19:15.945Z",
  "object_marking_refs": [
    "marking-definition--fa42a846-8d90-4e51-bc29-71d5b4802168"
  ],
  "relationship_type": "detects",
  "revoked": false,
  "source_ref": "x-mitre-data-component--3d20385b-24ef-40e1-9f56-f39750379077",
  "spec_version": "",
  "target_ref": "attack-pattern--9efb1ea7-c37b-4595-9640-b7680cd84279",
  "x_mitre_attack_spec_version": "3.1.0",
  "x_mitre_deprecated": false,
  "x_mitre_modified_by_ref": "identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5",
  "x_mitre_version": "0.1"
}
